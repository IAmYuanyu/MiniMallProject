import{D as y,r as l,i as v,f as g,p as m,s as S}from"./index-_0YP8fyM.js";const D=y("orders",()=>{const t=l([]),s=l(!1),c=l(0),O=1*60*1e3,p=v(()=>t.value.length),h=v(()=>t.value.reduce((r,e)=>{const a=e.items.reduce((o,n)=>o+n.price*n.quantity,0);return r+a},0)),i=()=>{const r=localStorage.getItem("orders");return r?(t.value=JSON.parse(r),!0):!1},d=()=>{localStorage.setItem("orders",JSON.stringify(t.value))},f=async(r=!1)=>{const e=Date.now();if(!r&&t.value.length>0&&e-c.value<O)return t.value;try{if(s.value=!0,!r&&i())return c.value=e,t.value;const a=await g.get("/orders");a.data.code===200&&(t.value=a.data.data,d(),c.value=e)}catch(a){console.error("获取订单列表失败",a),i()}finally{s.value=!1}return t.value};return{orders:t,loading:s,orderCount:p,totalOrderAmount:h,fetchOrders:f,submitOrder:async r=>{try{s.value=!0;const e=await g.post("/order/submit",r);if(e.data.code===200){const o=new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"),n={orderId:e.data.data.orderNo||Date.now().toString(),orderNo:e.data.data.orderNo,createTime:o,status:1,items:r.items.map(u=>({id:Date.now().toString()+Math.random(),title:u.product.title,thumb:u.product.image,price:u.product.price,quantity:u.quantity,status:1,createTime:o}))};return t.value.unshift(n),d(),m("下单成功"),{success:!0,order:n}}}catch(e){return console.error("提交订单失败",e),S("提交订单失败"),{success:!1,error:e}}finally{s.value=!1}},calculateOrderTotal:r=>r.reduce((e,a)=>e+a.price*a.quantity,0).toFixed(2),getOrderById:r=>t.value.find(e=>e.orderId===r),updateOrderStatus:(r,e)=>{const a=t.value.find(o=>o.orderId===r);a&&(a.status=e,d())},deleteOrder:r=>{const e=t.value.findIndex(a=>a.orderId===r);e>-1&&(t.value.splice(e,1),d(),m("删除成功"))},clearOrders:()=>{t.value=[],localStorage.removeItem("orders")},refresh:async()=>{await f(!0)}}});export{D as u};
